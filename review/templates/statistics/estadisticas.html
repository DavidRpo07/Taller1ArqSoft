{% extends "base_generic.html" %}

{% block title %}Estadísticas de Profesores{% endblock %}

{% block content %}
<!-- Incluir Bootstrap 5 y Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-5">
    <h2>Estadísticas de Rating por Semestre</h2>
    
    <!-- Formulario manual para seleccionar profesor -->
    <form method="POST">
        {% csrf_token %}
        <div class="mb-3">
            <label for="profesor" class="form-label">Seleccionar Profesor:</label>
            <select id="profesor" name="profesor" class="form-select" required>
                <option value="">--Seleccione un Profesor--</option>
                {% for profesor in profesores %}
                    <option value="{{ profesor.id }}" {% if profesor_seleccionado and profesor_seleccionado.id == profesor.id %}selected{% endif %}>
                        {{ profesor.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Generar Estadísticas</button>
    </form>

    <!-- Mostrar la gráfica solo si hay datos -->
    {% if promedios_por_semestre %}
    <div class="mt-5">
        <canvas id="lineChart"></canvas>
    </div>

    <!-- Serializar los datos usando json_script -->
    <script id="promedios-data" type="application/json">
        {{ promedios_por_semestre|json_script:"promedios" }}
    </script>

    <script>
        // Obtener los datos serializados desde el script JSON
        var promedios = JSON.parse(document.getElementById('promedios-data').textContent);

        // Crear arrays de labels (fechas) y data (promedios de rating)
        var labels = promedios.map(function(item) { return item.fecha; });
        var data = promedios.map(function(item) { return item.promedio_rating; });

        var ctx = document.getElementById('lineChart').getContext('2d');
        var lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,  // Fechas de los semestres
                datasets: [{
                    label: 'Promedio de Rating',
                    data: data,  // Promedios por semestre
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: 5
                    }
                }
            }
        });
    </script>
    {% endif %}
</div>

{% endblock %}
